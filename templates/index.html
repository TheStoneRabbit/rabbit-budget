<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Categorizer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 50px auto;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
        }
        .profile-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .danger-button {
            background-color: #dc3545;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .danger-button:hover {
            background-color: #c82333;
        }

        .danger-label {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            width: 320px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .modal h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .modal input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .lock-button {
            background-color: #6c757d;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            width: 44px;
            height: 44px;
        }

        .lock-button:hover {
            background-color: #5a6268;
        }
        select,
        input[type="file"],
        input[type="email"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* Ensure padding doesn't increase width */
        }

        /* Modern Search Bar Styling */
        #category-search,
        #rule-search {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #a0a0a0;
            border-radius: 25px; /* More rounded corners */
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #category-search:focus,
        #rule-search:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        #category-search::placeholder,
        #rule-search::placeholder {
            color: #888;
        }
        input[type="submit"] {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        input[type="submit"]:hover {
            background-color: #0056b3;
        }

        /* Styling for Add and Save buttons */
        #add-category,
        #add-rule {
            background-color: #007bff; /* Blue */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        #add-category:hover,
        #add-rule:hover {
            background-color: #0056b3;
        }

        #save-categories,
        #save-rules {
            background-color: #28a745; /* Green */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #save-categories:hover,
        #save-rules:hover {
            background-color: #218838;
        }
        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        /* Styling for category and rule items */
        .category-item,
        .rule-item {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between items */
            margin-bottom: 10px;
        }

        .category-item input[type="text"],
        .category-item input[type="number"],
        .rule-item input[type="text"] {
            flex: 1; /* Allow inputs to grow and shrink */
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .category-item button,
        .rule-item button {
            padding: 8px 12px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .category-item button:hover,
        .rule-item button:hover {
            background-color: #c82333;
        }

        .category-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .category-total {
            font-weight: bold;
            color: #333;
        }

        .category-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        #download-categories,
        #import-categories {
            background-color: #6c757d;
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        #download-categories:hover,
        #import-categories:hover {
            background-color: #5a6268;
        }

        .settings-item {
            margin-bottom: 15px;
        }

        .settings-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .settings-hint {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
            <h1>Upload Transactions for Categorization</h1>
            {% if profile != 'default' and not needs_password %}
            <button type="button" id="lock-profile" class="lock-button" title="Lock/Logout">ðŸ”’</button>
            {% endif %}
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form id="upload-form" method="post" enctype="multipart/form-data">
            <label for="profile">Select Profile:</label>
            <div class="profile-row">
                <select id="profile" name="profile">
                    {% for p in profiles %}
                    <option value="{{ p }}" {% if p == profile %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                    <option value="__new__">+ Create new profile...</option>
                </select>
            </div>

            <label for="file">Select CSV File:</label>
            <input type="file" id="file" name="file" accept=".csv" required>

            <label for="email">Your Email:</label>
            <input type="email" id="email" name="email" placeholder="Enter your email" required>

            <input type="submit" value="Upload and Categorize">
        </form>
    </div>
    <div class="container">
        <h2 class="collapsible-header" data-target="categories-content">Your Budget <span class="collapse-icon">&#9658;</span></h2>
        <div id="categories-content" class="collapsible-content" style="display: none;">
            <div class="category-toolbar">
                <button type="button" id="import-categories">Import CSV</button>
                <button type="button" id="download-categories">Download CSV</button>
                <input type="file" id="import-file" accept=".csv" style="display:none;">
            </div>
            <input type="text" id="category-search" placeholder="Search categories...">
            <form id="category-form">
                <div id="categories-container">
                    {% for category in categories %}
                    <div class="category-item" data-original-name="{{ category.name | e }}">
                        <input type="text" name="category-name" value="{{ category.name }}" required>
                        <input type="number" name="category-budget" value="{{ category.budget }}" step="0.01" required>
                        <button type="button" class="remove-category">Remove</button>
                    </div>
                    {% endfor %}
                </div>
                <div class="category-actions">
                    <button type="button" id="add-category">Add Category</button>
                    <button type="button" id="save-categories">Save Categories</button>
                    <div class="category-total">Total: <span id="category-total-value">$0.00</span></div>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <h2 class="collapsible-header" data-target="rules-content">Manage Category Rules <span class="collapse-icon">&#9658;</span></h2>
        <div id="rules-content" class="collapsible-content" style="display: none;">
            <input type="text" id="rule-search" placeholder="Search rules...">
            <form id="rules-form">
                <div id="rules-container">
                    <!-- Rules will be loaded here by JavaScript -->
                </div>
                <button type="button" id="add-rule">Add Rule</button>
                <button type="button" id="save-rules">Save Rules</button>
            </form>
        </div>
    </div>


    {% if profile != 'default' %}
    <div class="container">
        <h2 class="collapsible-header" data-target="settings-content">Settings <span class="collapse-icon">&#9658;</span></h2>
        <div id="settings-content" class="collapsible-content" style="display: none;">
            <div class="settings-item">
                <label>
                    <input type="checkbox" id="privacy-toggle">
                    Make Account Private
                </label>
                <p class="settings-hint">Require a password to access this profile and its budget.</p>
            </div>
            <div class="settings-item">
                <label>
                    <input type="checkbox" id="custom-columns-toggle">
                    Use custom CSV columns
                </label>
                <p class="settings-hint">Default Columns: 'Description' + 'Debit'. When enabled, set your column names below.</p>
                <label for="description-column">Description column</label>
                <input type="text" id="description-column" placeholder="Description">
                <label for="amount-column">Amount column</label>
                <input type="text" id="amount-column" placeholder="Debit">
            </div>
            <div class="settings-item">
                <button type="button" id="change-password">Change Password</button>
            </div>
            <button type="button" id="delete-profile" class="danger-button" style="width: 100%;">Delete Profile</button>
        </div>
    </div>
    {% endif %}

    <div class="modal-overlay" id="password-modal">
        <div class="modal">
            <h3 id="password-modal-title">Enter Password</h3>
            <input type="password" id="password-modal-input" placeholder="Password">
            <div class="modal-actions">
                <button type="button" id="password-modal-cancel">Cancel</button>
                <button type="button" id="password-modal-ok">OK</button>
            </div>
        </div>
    </div>

    <script>
        const activeProfile = {{ profile | tojson }};
        const basePath = '/rabbitbudget';
        let initialCategories = {{ categories | tojson }};
        let initialRules = {};
        let profileSettings = { is_private: false, has_password: false, protect_deletion: false };
        let categoriesUnlocked = true;
        const requiresPassword = {{ needs_password | default(false) | tojson }};
        initialCategories = initialCategories.map(cat => ({
            name: cat.name,
            budget: Number(cat.budget)
        }));

        document.addEventListener('DOMContentLoaded', function() {
            const profileSelect = document.getElementById('profile');
            const uploadForm = document.getElementById('upload-form');
            const saveCategoriesButton = document.getElementById('save-categories');
            const saveRulesButton = document.getElementById('save-rules');
            const deleteProfileButton = document.getElementById('delete-profile');
            const privacyToggle = document.getElementById('privacy-toggle');
            const changePasswordButton = document.getElementById('change-password');
            const downloadCategoriesButton = document.getElementById('download-categories');
            const importCategoriesButton = document.getElementById('import-categories');
            const importFileInput = document.getElementById('import-file');
            const customColumnsToggle = document.getElementById('custom-columns-toggle');
            const descriptionColumnInput = document.getElementById('description-column');
            const amountColumnInput = document.getElementById('amount-column');
            const lockProfileButton = document.getElementById('lock-profile');
            const passwordModal = document.getElementById('password-modal');
            const passwordModalInput = document.getElementById('password-modal-input');
            const passwordModalOk = document.getElementById('password-modal-ok');
            const passwordModalCancel = document.getElementById('password-modal-cancel');
            const passwordModalTitle = document.getElementById('password-modal-title');

            const promptPassword = (title) => {
                return new Promise((resolve) => {
                    if (!passwordModal || !passwordModalInput || !passwordModalOk || !passwordModalCancel) {
                        const fallback = prompt(title || 'Enter password:');
                        resolve(fallback || null);
                        return;
                    }
                    passwordModalTitle.textContent = title || 'Enter password';
                    passwordModal.style.display = 'flex';
                    passwordModalInput.value = '';
                    passwordModalInput.focus();

                    const close = (value) => {
                        passwordModal.style.display = 'none';
                        passwordModalOk.removeEventListener('click', okHandler);
                        passwordModalCancel.removeEventListener('click', cancelHandler);
                        passwordModalInput.removeEventListener('keydown', keyHandler);
                        resolve(value);
                    };
                    const okHandler = () => close(passwordModalInput.value || null);
                    const cancelHandler = () => close(null);
                    const keyHandler = (e) => {
                        if (e.key === 'Enter') {
                            okHandler();
                        }
                        if (e.key === 'Escape') {
                            cancelHandler();
                        }
                    };
                    passwordModalOk.addEventListener('click', okHandler);
                    passwordModalCancel.addEventListener('click', cancelHandler);
                    passwordModalInput.addEventListener('keydown', keyHandler);
                });
            };

            if (profileSelect) {
                profileSelect.addEventListener('change', async function() {
                    const selectedProfile = this.value;
                    if (selectedProfile === '__new__') {
                        const name = prompt('Enter new profile name:');
                        if (!name) {
                            this.value = activeProfile;
                            return;
                        }
                        const adminPassword = await promptPassword('Enter admin password to create a profile:');
                        if (!adminPassword) {
                            this.value = activeProfile;
                            return;
                        }
                        fetch(`${basePath}/profiles`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name, admin_password: adminPassword })
                        }).then(async (response) => {
                            if (response.status === 409) {
                                alert('A profile with that name already exists.');
                                this.value = activeProfile;
                                return;
                            }
                            if (response.status === 403) {
                                const error = await response.json().catch(() => ({}));
                                alert(error.error || 'Admin password required or incorrect.');
                                this.value = activeProfile;
                                return;
                            }
                            if (!response.ok) {
                                throw new Error('Failed to create profile');
                            }
                            const data = await response.json();
                            window.location.href = `${basePath}/` + encodeURIComponent(data.name);
                        }).catch(err => {
                            console.error(err);
                            alert('Error creating profile.');
                            this.value = activeProfile;
                        });
                        return;
                    }
                    if (selectedProfile) {
                        try {
                            const settingsResp = await fetch(`${basePath}/profiles/${encodeURIComponent(selectedProfile)}/settings`);
                            if (settingsResp.status === 401) {
                                // Needs password; fall through to prompt
                            } else if (!settingsResp.ok) {
                                throw new Error('Unable to load profile settings.');
                            } else {
                                const settings = await settingsResp.json();
                                if (!settings.is_private) {
                                    window.location.href = `${basePath}/` + selectedProfile;
                                    return;
                                }
                            }

                            const password = await promptPassword(`Enter password for "${selectedProfile}":`);
                            if (!password) {
                                this.value = activeProfile;
                                return;
                            }
                            const verifyResp = await fetch(`${basePath}/profiles/${encodeURIComponent(selectedProfile)}/settings/verify`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ password })
                            });
                            if (!verifyResp.ok) {
                                alert('Incorrect password.');
                                this.value = activeProfile;
                                return;
                            }
                            const verifyData = await verifyResp.json();
                            if (!verifyData.ok) {
                                alert('Incorrect password.');
                                this.value = activeProfile;
                                return;
                            }
                            window.location.href = `${basePath}/` + selectedProfile;
                        } catch (err) {
                            console.error(err);
                            alert('Error loading profile.');
                            this.value = activeProfile;
                        }
                    }
                });
            }

            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    const selectedProfile = profileSelect.value;
                    if (selectedProfile) {
                        this.action = `${basePath}/` + selectedProfile + '/upload';
                    }
                });
            }

            const updateSettingsUI = () => {
                if (privacyToggle) {
                    privacyToggle.checked = !!profileSettings.is_private;
                }
                if (changePasswordButton) {
                    changePasswordButton.disabled = !profileSettings.has_password;
                }
                if (!profileSettings.is_private) {
                    categoriesUnlocked = true;
                }
                if (customColumnsToggle) {
                    customColumnsToggle.checked = !!profileSettings.custom_columns;
                }
                if (descriptionColumnInput && amountColumnInput) {
                    descriptionColumnInput.value = profileSettings.description_column || '';
                    amountColumnInput.value = profileSettings.amount_column || '';
                    // Always editable; toggle only controls whether values are used.
                    descriptionColumnInput.disabled = false;
                    amountColumnInput.disabled = false;
                }
            };

            const loadProfileSettings = async () => {
                try {
                    const response = await fetch(`${basePath}/profiles/${encodeURIComponent(activeProfile)}/settings`);
                    if (response.status === 401) {
                        return false;
                    }
                    if (!response.ok) {
                        return false;
                    }
                    const data = await response.json();
                    profileSettings = data;
                    categoriesUnlocked = !profileSettings.is_private;
                    updateSettingsUI();
                    return true;
                } catch (err) {
                    console.error(err);
                    return false;
                }
            };

            privacyToggle?.addEventListener('change', async function() {
                if (this.checked) {
                    const password = await promptPassword('Set a password to make this account private:');
                    if (!password) {
                        this.checked = false;
                        return;
                    }
                    const confirmPassword = await promptPassword('Confirm password:');
                    if (password !== confirmPassword) {
                        alert('Passwords do not match.');
                        this.checked = false;
                        return;
                    }
                    try {
                        const response = await fetch(`${basePath}/profiles/${encodeURIComponent(activeProfile)}/settings/privacy`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_private: true, password })
                        });
                        if (!response.ok) {
                            throw new Error('Failed to enable privacy');
                        }
                        profileSettings = await response.json();
                        categoriesUnlocked = false;
                        updateSettingsUI();
                        alert('Account is now private. Access will require the password.');
                    } catch (err) {
                        console.error(err);
                        alert('Error enabling privacy.');
                        this.checked = false;
                    }
                } else {
                    const confirmed = confirm('Disable privacy for this profile?');
                    if (!confirmed) {
                        this.checked = true;
                        return;
                    }
                    const password = await promptPassword('Enter password to make this account public:');
                    if (!password) {
                        this.checked = true;
                        return;
                    }
                    try {
                        const response = await fetch(`${basePath}/profiles/${encodeURIComponent(activeProfile)}/settings/privacy`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_private: false, password })
                        });
                        if (!response.ok) {
                            throw new Error('Failed to disable privacy');
                        }
                        profileSettings = await response.json();
                        categoriesUnlocked = true;
                        updateSettingsUI();
                    } catch (err) {
                        console.error(err);
                        alert('Error disabling privacy.');
                        this.checked = true;
                    }
                }
            });

            customColumnsToggle?.addEventListener('change', async function() {
                const enable = this.checked;
                const desc = descriptionColumnInput?.value || '';
                const amt = amountColumnInput?.value || '';
                try {
                    const response = await fetch(`${basePath}/profiles/${encodeURIComponent(activeProfile)}/settings/columns`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            custom: enable,
                            description_column: desc,
                            amount_column: amt
                        })
                    });
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        const message = error.error || 'Failed to update column settings.';
                        throw new Error(message);
                    }
                    profileSettings = await response.json();
                    updateSettingsUI();
                } catch (err) {
                    console.error(err);
                    alert(err.message || 'Error saving column settings.');
                    this.checked = !enable;
                }
            });

            descriptionColumnInput?.addEventListener('blur', () => {
                if (customColumnsToggle?.checked) {
                    customColumnsToggle.dispatchEvent(new Event('change'));
                }
            });

            amountColumnInput?.addEventListener('blur', () => {
                if (customColumnsToggle?.checked) {
                    customColumnsToggle.dispatchEvent(new Event('change'));
                }
            });

            changePasswordButton?.addEventListener('click', async function() {
                if (!profileSettings.has_password) {
                    alert('Set a password first (enable privacy or delete protection).');
                    return;
                }
                const oldPassword = await promptPassword('Enter current password:');
                if (!oldPassword) {
                    return;
                }
                const newPassword = await promptPassword('Enter new password:');
                if (!newPassword) {
                    return;
                }
                const confirmNew = await promptPassword('Confirm new password:');
                if (newPassword !== confirmNew) {
                    alert('Passwords do not match.');
                    return;
                }
                try {
                    const response = await fetch(`${basePath}/profiles/${encodeURIComponent(activeProfile)}/settings/change-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                    });
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        const message = error.error || 'Failed to change password';
                        throw new Error(message);
                    }
                    alert('Password updated.');
                    categoriesUnlocked = false;
                    updateSettingsUI();
                } catch (err) {
                    console.error(err);
                    alert(err.message || 'Error changing password.');
                }
            });

            downloadCategoriesButton?.addEventListener('click', async function() {
                let passwordParam = '';
                if (profileSettings.is_private) {
                    const password = await promptPassword('Enter password to download categories:');
                    if (!password) {
                        return;
                    }
                    passwordParam = `?password=${encodeURIComponent(password)}`;
                }
                try {
                    const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/categories/export${passwordParam}`);
                    if (response.status === 401) {
                        alert('Password required or incorrect.');
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Failed to download categories.');
                    }
                    const blob = await response.blob();
                    const disposition = response.headers.get('Content-Disposition') || '';
                    const match = disposition.match(/filename=\"?([^\";]+)\"?/);
                    const filename = match && match[1] ? match[1] : 'categories.csv';
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error(err);
                    alert('Error downloading categories.');
                }
            });

            importCategoriesButton?.addEventListener('click', function() {
                importFileInput?.click();
            });

            importFileInput?.addEventListener('change', async function() {
                if (!this.files || !this.files.length) {
                    return;
                }
                const file = this.files[0];
                let password = '';
                if (profileSettings.is_private) {
                    const provided = await promptPassword('Enter password to import categories:');
                    if (!provided) {
                        this.value = '';
                        return;
                    }
                    password = provided;
                }
                const formData = new FormData();
                formData.append('file', file);
                if (password) {
                    formData.append('password', password);
                }

                try {
                    const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/categories/import`, {
                        method: 'POST',
                        body: formData
                    });
                    if (response.status === 401) {
                        alert('Password required or incorrect.');
                        this.value = '';
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Failed to import categories.');
                    }
                    const result = await response.json();
                    alert(`Import complete. Added ${result.added} categories.`);
                    window.location.reload();
                } catch (err) {
                    console.error(err);
                    alert('Error importing categories.');
                } finally {
                    this.value = '';
                }
            });


            // Collapsible Headers
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', function() {
                    const targetId = this.dataset.target;
                    const targetContent = document.getElementById(targetId);
                    const icon = this.querySelector('.collapse-icon');

                    if (targetContent.style.display === 'none') {
                        targetContent.style.display = 'block';
                        icon.innerHTML = '&#9660;'; // Down arrow
                    } else {
                        targetContent.style.display = 'none';
                        icon.innerHTML = '&#9658;'; // Right arrow
                    }
                });
            });

            // Initial collapse state (all collapsed by default)
            document.querySelectorAll('.collapsible-content').forEach(content => {
                content.style.display = 'none'; // Start collapsed
            });

            // Category Search
            const categorySearch = document.getElementById('category-search');
            if (categorySearch) {
                categorySearch.addEventListener('keyup', function() {
                    const searchTerm = this.value.toLowerCase();
                    document.querySelectorAll('#categories-container .category-item').forEach(item => {
                        const categoryName = item.querySelector('input[name="category-name"]').value.toLowerCase();
                        if (categoryName.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }

            // Add Category Button
            document.getElementById('add-category').addEventListener('click', function() {
                const container = document.getElementById('categories-container');
                const newItem = document.createElement('div');
                newItem.classList.add('category-item');
                newItem.dataset.originalName = '';
                newItem.innerHTML = `
                    <input type="text" name="category-name" placeholder="Category Name" required>
                    <input type="number" name="category-budget" placeholder="Budget" step="0.01" required>
                    <button type="button" class="remove-category">Remove</button>
                `;
                container.appendChild(newItem);
                updateCategoryTotal();
            });

            // Remove Category Button
            document.getElementById('categories-container').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-category')) {
                    e.target.parentElement.remove();
                    updateCategoryTotal();
                }
            });

            const getCurrentCategories = () => {
                const categories = [];
                document.querySelectorAll('.category-item').forEach(item => {
                    const nameField = item.querySelector('input[name="category-name"]');
                    const budgetField = item.querySelector('input[name="category-budget"]');
                    const name = nameField.value.trim();
                    const budgetValue = parseFloat(budgetField.value);
                    const originalName = (item.dataset.originalName || '').trim();
                    if (name) {
                        categories.push({
                            name,
                            budget: Number.isFinite(budgetValue) ? budgetValue : 0,
                            originalName: originalName || null,
                        });
                    }
                });
                return categories;
            };

            const updateCategoryTotal = () => {
                const total = getCurrentCategories().reduce((sum, cat) => sum + (Number.isFinite(cat.budget) ? cat.budget : 0), 0);
                const totalEl = document.getElementById('category-total-value');
                if (totalEl) {
                    totalEl.textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(total);
                }
            };

            document.getElementById('categories-container').addEventListener('input', function(e) {
                if (e.target.name === 'category-budget') {
                    updateCategoryTotal();
                }
            });

            const saveCategories = async () => {
                const currentCategories = getCurrentCategories();
                const initialMap = new Map(initialCategories.map(cat => [cat.name.toLowerCase(), cat]));

                const toDelete = initialCategories
                    .filter(cat => !currentCategories.some(item => {
                        const reference = (item.originalName || item.name || '').toLowerCase();
                        return reference === cat.name.toLowerCase();
                    }))
                    .map(cat => cat.name);

                const toCreate = currentCategories.filter(cat => !cat.originalName);
                const toUpdate = currentCategories.filter(cat => {
                    if (!cat.originalName) {
                        return false;
                    }
                    const baseline = initialMap.get(cat.originalName.toLowerCase());
                    if (!baseline) {
                        return true;
                    }
                    const nameChanged = cat.originalName.toLowerCase() !== cat.name.toLowerCase();
                    const budgetChanged = Number.parseFloat(baseline.budget) !== cat.budget;
                    return nameChanged || budgetChanged;
                });

                try {
                    for (const name of toDelete) {
                        const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/categories/${encodeURIComponent(name)}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok && response.status !== 204) {
                            throw new Error(`Failed to delete category ${name}`);
                        }
                    }

                    for (const entry of toUpdate) {
                        const targetName = entry.originalName || entry.name;
                        const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/categories/${encodeURIComponent(targetName)}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: entry.name,
                                budget: entry.budget
                            })
                        });
                        if (!response.ok) {
                            throw new Error(`Failed to update category ${entry.name}`);
                        }
                    }

                    for (const entry of toCreate) {
                        const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/categories`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(entry)
                        });
                        if (!response.ok) {
                            throw new Error(`Failed to create category ${entry.name}`);
                        }
                    }

                    alert('Categories saved successfully!');
                    document.querySelectorAll('.category-item').forEach(item => {
                        const nameField = item.querySelector('input[name="category-name"]');
                        if (nameField) {
                            item.dataset.originalName = nameField.value.trim();
                        }
                    });
                    const refreshedCategories = getCurrentCategories();
                    initialCategories = refreshedCategories.map(cat => ({
                        name: cat.name,
                        budget: cat.budget
                    }));
                } catch (error) {
                    console.error(error);
                    alert('Error saving categories.');
                }
            };

            saveCategoriesButton?.addEventListener('click', function() {
                saveCategories();
            });

            updateCategoryTotal();

            // Rule Search
            const ruleSearch = document.getElementById('rule-search');
            if (ruleSearch) {
                ruleSearch.addEventListener('keyup', function() {
                    const searchTerm = this.value.toLowerCase();
                    document.querySelectorAll('#rules-container .rule-item').forEach(item => {
                        const keyword = item.querySelector('input[name="rule-keyword"]').value.toLowerCase();
                        const category = item.querySelector('input[name="rule-category"]').value.toLowerCase();
                        if (keyword.includes(searchTerm) || category.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }

            if (deleteProfileButton) {
                deleteProfileButton.addEventListener('click', async function() {
                    const confirmed = confirm(`Delete profile "${activeProfile}"? This cannot be undone.`);
                    if (!confirmed) {
                        return;
                    }
                    let password = '';
                    if (profileSettings.protect_deletion || profileSettings.is_private) {
                        const provided = await promptPassword('Enter password to delete this profile:');
                        if (!provided) {
                            return;
                        }
                        password = provided;
                    }
                    try {
                        const response = await fetch(`${basePath}/profiles/${encodeURIComponent(activeProfile)}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ password })
                        });
                        if (response.status === 404) {
                            alert('Profile not found.');
                            return;
                        }
                        if (!response.ok) {
                            throw new Error('Failed to delete profile');
                        }
                        window.location.href = '/';
                    } catch (err) {
                        console.error(err);
                        alert('Error deleting profile.');
                    }
                });
            }

            const loadRules = async () => {
                try {
                    const response = await fetch(`${basePath}/` + encodeURIComponent(activeProfile) + '/rules');
                    if (!response.ok) {
                        return;
                    }
                    const rules = await response.json();
                    initialRules = { ...rules };
                    const container = document.getElementById('rules-container');
                    container.innerHTML = '';
                    for (const keyword in rules) {
                        const category = rules[keyword];
                        const newItem = document.createElement('div');
                        newItem.classList.add('rule-item');
                        newItem.innerHTML = `
                            <input type="text" name="rule-keyword" value="${keyword}" required>
                            <input type="text" name="rule-category" value="${category}" required>
                            <button type="button" class="remove-rule">Remove</button>
                        `;
                        container.appendChild(newItem);
                    }
                } catch (err) {
                    console.error(err);
                }
            };

            // Add Rule Button
            document.getElementById('add-rule').addEventListener('click', function() {
                const container = document.getElementById('rules-container');
                const newItem = document.createElement('div');
                newItem.classList.add('rule-item');
                newItem.innerHTML = `
                    <input type="text" name="rule-keyword" placeholder="Keyword" required>
                    <input type="text" name="rule-category" placeholder="Category" required>
                    <button type="button" class="remove-rule">Remove</button>
                `;
                container.appendChild(newItem);
            });

            // Remove Rule Button
            document.getElementById('rules-container').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-rule')) {
                    e.target.parentElement.remove();
                }
            });

            const getCurrentRules = () => {
                const rules = {};
                document.querySelectorAll('.rule-item').forEach(item => {
                    const keywordField = item.querySelector('input[name="rule-keyword"]');
                    const categoryField = item.querySelector('input[name="rule-category"]');
                    const keyword = keywordField.value.trim();
                    const category = categoryField.value.trim();
                    if (keyword) {
                        rules[keyword.toUpperCase()] = category;
                    }
                });
                return rules;
            };

            const saveRules = async () => {
                const currentRules = getCurrentRules();
                const initialKeys = Object.keys(initialRules);
                const currentKeys = Object.keys(currentRules);

                const toDelete = initialKeys.filter(key => !currentKeys.includes(key));
                const toCreate = currentKeys.filter(key => !initialKeys.includes(key));
                const toUpdate = currentKeys.filter(key => initialKeys.includes(key) && initialRules[key] !== currentRules[key]);

                try {
                    for (const key of toDelete) {
                        const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/rules/${encodeURIComponent(key)}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok && response.status !== 204) {
                            throw new Error(`Failed to delete rule ${key}`);
                        }
                    }

                    for (const key of toUpdate) {
                        const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/rules/${encodeURIComponent(key)}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                keyword: key,
                                category: currentRules[key]
                            })
                        });
                        if (!response.ok) {
                            throw new Error(`Failed to update rule ${key}`);
                        }
                    }

                    for (const key of toCreate) {
                        const response = await fetch(`${basePath}/${encodeURIComponent(activeProfile)}/rules`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                keyword: key,
                                category: currentRules[key]
                            })
                        });
                        if (!response.ok) {
                            throw new Error(`Failed to create rule ${key}`);
                        }
                    }

                    alert('Rules saved successfully!');
                    initialRules = { ...currentRules };
                } catch (error) {
                    console.error(error);
                    alert('Error saving rules.');
                }
            };

            saveRulesButton?.addEventListener('click', function() {
                saveRules();
            });

            const ensureAccess = async () => {
                if (!requiresPassword) {
                    return;
                }
                const password = await promptPassword(`Enter password for "${activeProfile}":`);
                if (!password) {
                    alert('Password is required to access this profile.');
                    window.location.href = '/';
                    return;
                }
                try {
                    const verifyResp = await fetch(`${basePath}/profiles/${encodeURIComponent(activeProfile)}/settings/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (!verifyResp.ok) {
                        alert('Incorrect password.');
                        window.location.href = '/';
                        return;
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error verifying password.');
                    window.location.href = '/';
                }
                // Reload to pull data now that session is authorized
                window.location.reload();
            };

            const init = async () => {
                if (requiresPassword) {
                    await ensureAccess();
                    return; // reload will occur
                }
                await loadProfileSettings();
                await loadRules();
            };

            init();

            lockProfileButton?.addEventListener('click', async function() {
                try {
                    await fetch(`${basePath}/logout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ profile: activeProfile })
                    });
                } catch (err) {
                    console.error(err);
                } finally {
                    window.location.href = '/';
                }
            });
        });
    </script>
</body>
</html>
